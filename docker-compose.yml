# Docker Compose Configuration for Commercial Site
#
# STARTUP INSTRUCTIONS:
# =====================
# 1. Start all services (Kafka, Zookeeper, MailHog):
#    docker-compose up -d
#
# 2. Start specific services:
#    docker-compose up -d zookeeper kafka mailhog
#
# 3. View logs:
#    docker-compose logs -f kafka
#    docker-compose logs -f mailhog
#
# 4. Stop services:
#    docker-compose stop
#
# 5. Stop and remove containers:
#    docker-compose down
#
# SERVICES:
# =========
# - zookeeper: Kafka dependency (port 2181)
# - kafka: Message broker (port 9092)
# - mailhog: Mail server for testing (SMTP: 1025, Web UI: 8025)
# - create-topics: One-time service to create Kafka topics
#
# ACCESS:
# =======
# - Kafka: localhost:9092
# - MailHog Web UI: http://localhost:8025
# - MailHog SMTP: localhost:1025

version: "3.8"

services:
  zookeeper:
    image: confluentinc/cp-zookeeper:latest
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"

  kafka:
    image: confluentinc/cp-kafka:latest
    depends_on:
      - zookeeper
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      # Listeners: what Kafka listens on inside the container
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:9092
      # Advertised listeners: what clients should connect to
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://localhost:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_AUTO_CREATE_TOPICS_ENABLE: "true"
      # Additional configuration for better reliability
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
    healthcheck:
      test: [ "CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1" ]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  mailhog:
    image: mailhog/mailhog:v1.0.1
    ports:
      - "1025:1025" # SMTP
      - "8025:8025" # Web UI

  create-topics:
    image: confluentinc/cp-kafka:latest
    depends_on:
      kafka:
        condition: service_healthy
    entrypoint: [
      "bash","-c",
      "kafka-topics --bootstrap-server kafka:9092 --create --if-not-exists --topic orders.created --replication-factor 1 --partitions 1"
    ]



